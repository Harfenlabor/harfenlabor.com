{{ define "main" }}
{{ partial "navigation.html" . }}
{{"<!-- Start Blog Section -->" | safeHTML}}
<section class="section greyBackground tl_mainbody">

  <div class="col-12 tl_upperpart">
    <div class="text-center wow fadeInDown">
      <h1>{{ .Title }}</h1>
      <div class="border-meghna"></div>
      <!--p>ciao</p-->
    </div>
  </div>
  <div id="map_hl"></div>

  {{"<!-- /section title -->" | safeHTML}}
  {{ $timelinePagination := .Site.GetPage "/research" }}

  {{ range $timelinePagination.Data.Pages }}
    {{ if not .Params.hide_from_research }}
      {{/* .Render "article_tl" */}}
    {{ end }}
  {{ end }}

  </div>
</section>
<script>
  // Creating map options
  var mapOptions = {
    center: [46, 12],
    zoom: 5
  }
  var map = new L.map('map_hl', mapOptions);
  var layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
  map.addLayer(layer);

  //get Map tags
  getJsonArray_map();
  function getJsonArray_map(){
    $.ajax({
        url: '/index.json',
        type: 'GET',
        success: maptags
    })
  }
  function clean_map(array) {
    for (var key in array) {
      if (array[key] === null || array[key] === undefined) {
        delete array[key];
      }
    }
    return array
  }
  var allNames_map = [];
  var allLinks_map = [];
  var allTitles_map = [];
  var arrayForMap = [];

  function maptags(data){
    json = data; //fetch my json
    for (var key in json) { //for each key in the json…
      if (json.hasOwnProperty(key)) { //unless that key is not used…
        var dirtyArray = json[key]; //create an array of those results…
        var result = clean_map(dirtyArray); //and clean it.
        if (result.hasOwnProperty("maptags")) { //and if the key "maptags" exists…
          for (let i = 0; i < result.maptags.length; i++) { //for each result in "maptags"…
            var singleMapTag = result.maptags[i];
            //exceptions in the name (unusable characters)
            /*if (singleMapTag.includes('ç')){
              singleMapTag = singleMapTag.replaceAll('ç', 'c');
            }*/
            allNames_map.push(singleMapTag);
            allLinks_map.push(result.permalink);
            allTitles_map.push(result.title);
          }
        }
      }
    }
    const sortedNames = allNames_map.map((key, ind) => ({ 'name': key, 'link': [allLinks_map[ind]], 'title': [allTitles_map[ind]]}));
    sortedNames.sort((a, b) => (a.name > b.name) ? 1 : -1);
    //adjust, remove duplicates
    for (var i = 0; i < sortedNames.length; i++) {
      if ((i != 0)&&(sortedNames[i].name == sortedNames[i-1].name)){
        sortedNames[i-1].link.push(sortedNames[i].link[0]);
        sortedNames[i-1].title.push(sortedNames[i].title[0]);
        sortedNames.splice(i, 1);
        i = i-1;
      }
    }
    
    console.log(sortedNames.length);
    for (var i = 0; i < sortedNames.length; i++) {
      var address = sortedNames[i].name;
      console.log(address);
      $.get('https://nominatim.openstreetmap.org/search?format=json&q='+address, function(data){
        console.log(data[0].lat, data[0].lon);
        var circle = L.circle([data[0].lat, data[0].lon], {
        color: 'var(--purpleColor)',
        fillColor: 'var(--purpleColor)',
        fillOpacity: 0.2,
        radius: 10000, /*rendi relativa a quanti articoli ne parlano!*/
        alt: address}).addTo(map).bindPopup("Ciao! <a href='https://www.google.it/'>"+address+"</a> è un link.");
      });
    }
    //return false;
  }

</script>
{{ end }}
